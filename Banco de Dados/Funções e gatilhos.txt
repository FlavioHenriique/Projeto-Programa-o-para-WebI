CREATE FUNCTION mediausuario(varchar)
RETURNS real as $$
DECLARE email alias for $1;
	media real;
BEGIN
	SELECT INTO media  AVG(nota) FROM AVALIACAO WHERE usuarioAvaliado = email;
	return media;
END $$
LANGUAGE PLPGSQL;

CREATE FUNCTION notausuario() 
RETURNS TRIGGER as $$
BEGIN
	UPDATE USUARIO SET NOTA = mediausuario(new.usuarioAvaliado) where email = new.usuarioAvaliado;
	return null;
	
end $$
LANGUAGE PLPGSQL;

CREATE TRIGGER calculaMedia
AFTER INSERT OR UPDATE ON avaliacao
FOR EACH ROW 
EXECUTE PROCEDURE notausuario();