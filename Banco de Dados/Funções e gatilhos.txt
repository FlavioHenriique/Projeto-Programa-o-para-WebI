CREATE FUNCTION mediausuario(varchar)
returns real as $$
declare email alias for $1;
	media real;
begin
	SELECT INTO media  AVG(nota) FROM AVALIACAO WHERE usuarioAvaliado = email;
	return media;
end $$
language plpgsql;

create function notausuario() 
returns trigger as $$
begin
	UPDATE USUARIO SET NOTA = mediausuario(new.usuarioAvaliado) where email = new.usuarioAvaliado;
	return null;
	
end $$
language plpgsql

create trigger calculaMedia
after insert or update on avaliacao
for each row
execute procedure notausuario();