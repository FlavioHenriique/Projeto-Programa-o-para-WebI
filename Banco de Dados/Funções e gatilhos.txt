CREATE OR REPLACE FUNCTION mediausuario(varchar)
RETURNS real as $$
DECLARE email alias for $1;
	media real;
BEGIN
	SELECT INTO media  AVG(nota) FROM AVALIACAO WHERE usuarioAvaliado = email;
	return media;
END $$
LANGUAGE PLPGSQL;

CREATE OR REPLACE FUNCTION notausuario() 
RETURNS TRIGGER as $$
BEGIN
	UPDATE USUARIO SET NOTA = mediausuario(NEW.usuarioAvaliado) where email = new.usuarioAvaliado;
	return null;
	
end $$
LANGUAGE PLPGSQL;

CREATE OR REPLACE FUNCTION atualizanota() 
RETURNS TRIGGER as $$
BEGIN
	UPDATE USUARIO SET NOTA = mediausuario(old.usuarioAvaliado) where email = old.usuarioAvaliado;
	return null;
	
end $$
LANGUAGE PLPGSQL;

CREATE TRIGGER calculaMedia
AFTER INSERT OR UPDATE ON avaliacao
FOR EACH ROW 
EXECUTE PROCEDURE notausuario();

CREATE TRIGGER atualizaMedia
AFTER DELETE ON avaliacao
FOR EACH ROW 
EXECUTE PROCEDURE atualizanota();